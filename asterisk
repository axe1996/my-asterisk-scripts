#!/bin/bash
set -e

echo "[*] Обновление системы..."
sudo apt-get update
sudo apt-get upgrade -y

echo "[*] Установка зависимостей..."
sudo apt-get install -y build-essential git subversion wget \
  libjansson-dev sqlite3 libsqlite3-dev uuid-dev \
  libxml2-dev libncurses-dev libedit-dev \
  autoconf automake libtool pkg-config

echo "[*] Переход в /usr/src и загрузка Asterisk..."
cd /usr/src/
sudo wget -O asterisk-20-current.tar.gz https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20-current.tar.gz
sudo tar zxf asterisk-20-current.tar.gz

# Определим имя директории
ASTERISK_DIR=$(tar -tf asterisk-20-current.tar.gz | head -1 | cut -d/ -f1)
cd "$ASTERISK_DIR"

echo "[*] Получение MP3-поддержки..."
sudo contrib/scripts/get_mp3_source.sh

echo "[*] Установка prereq-зависимостей от Asterisk..."
sudo contrib/scripts/install_prereq install

echo "[*] Конфигурация сборки..."
sudo ./configure

echo "[*] Включение поддержки MP3..."
sudo menuselect/menuselect --enable format_mp3 menuselect.makeopts

echo "[*] Сборка и установка Asterisk..."
sudo make -j$(nproc)
sudo make install
sudo make samples
sudo make basic-pbx
sudo make config
sudo ldconfig

echo "[*] Разрешение портов для SIP и RTP..."
sudo ufw allow 5060/udp
sudo ufw allow 10000:20000/udp

echo "[*] Запуск и включение Asterisk в автозагрузку..."
sudo systemctl start asterisk
sudo systemctl enable asterisk

echo "[✓] Установка завершена. Запусти консоль: sudo asterisk -rvvv"

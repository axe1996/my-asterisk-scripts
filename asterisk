#!/bin/bash

set -e

echo "[INFO] Обновление системы..."
sudo apt-get update -y
sudo apt-get upgrade -y

echo "[INFO] Установка зависимостей..."
sudo apt-get install -y build-essential git-core subversion wget libjansson-dev sqlite autoconf automake libxml2-dev libncurses5-dev libtool

echo "[INFO] Скачивание Asterisk 20..."
cd /usr/src/
sudo wget -q http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20-current.tar.gz
sudo tar zxf asterisk-20-current.tar.gz
cd asterisk-*/

echo "[INFO] Получение MP3 источников..."
sudo contrib/scripts/get_mp3_source.sh

echo "[INFO] Установка дополнительных зависимостей..."
sudo contrib/scripts/install_prereq install -y

echo "[INFO] Конфигурация Asterisk..."
sudo ./configure

echo "[INFO] Открытие menuselect (интерактивно, ESC → X для выхода)..."
sudo make menuselect.makeopts

echo "[INFO] Сборка Asterisk..."
sudo make -j$(nproc)

echo "[INFO] Установка Asterisk..."
sudo make install
sudo make samples
sudo make basic-pbx
sudo make config
sudo ldconfig

echo "[INFO] Запуск и добавление в автозагрузку..."
sudo systemctl start asterisk
sudo systemctl enable asterisk

echo "[INFO] Настройка фаервола..."
sudo ufw allow 5060/udp
sudo ufw allow 10000:20000/udp

echo "[DONE] Установка завершена. Asterisk должен работать."
